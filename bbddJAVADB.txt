CREATE TABLE PRODUCTO (
  ID_PRODUCTO INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY (START WITH 1, INCREMENT BY 1),
  NOMBRE VARCHAR(45) NOT NULL,
  DESCRIPCION VARCHAR(45) NOT NULL,
  PRECIO_SALIDA DOUBLE NOT NULL,
  URL_FOTO VARCHAR(45) NOT NULL,
  CATEGORIA INT NOT NULL,
  PUBLICADOR INT NOT NULL,
  EN_PROMOCION BOOLEAN NOT NULL,
  PRIMARY KEY (ID_PRODUCTO));

CREATE TABLE CATEGORIA (
  ID_CATEGORIA INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY (START WITH 1, INCREMENT BY 1),
  NOMBRE VARCHAR(45) DEFAULT NULL,
  PRIMARY KEY (ID_CATEGORIA));

CREATE TABLE CATEGORIA_PRODUCTO (
  PRODUCTO INTEGER NOT NULL,
  CATEGORIA INTEGER NOT NULL,
  PRIMARY KEY (PRODUCTO, CATEGORIA));


CREATE TABLE DIRECCION (
  ID_DIRECCION INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY (START WITH 1, INCREMENT BY 1),
  TIPO VARCHAR(7) NOT NULL,
  CALLE VARCHAR(45) NOT NULL,
  NUMERO INTEGER NOT NULL,
  CODIGO_POSTAL INTEGER NOT NULL,
  PLANTA INTEGER NOT NULL,
  PUERTA VARCHAR(45) NOT NULL,
  CONSTRAINT TIPO_VALIDO CHECK (TIPO IN ('OFICINA','CALLE')),
  PRIMARY KEY (ID_DIRECCION));

CREATE TABLE USUARIO (
  ID_USUARIO INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY (START WITH 1, INCREMENT BY 1),
  NOMBRE_USUARIO VARCHAR(45) NOT NULL,
  CONTRASENYA VARCHAR(45) NOT NULL,
  EMAIL VARCHAR(45) NOT NULL,
  NOMBRE VARCHAR(45) NOT NULL,
  PRIMER_APELLIDO VARCHAR(45) NOT NULL,
  SEGUNDO_APELLIDO VARCHAR(45) NOT NULL,
  DIRECCION INTEGER NOT NULL,
  FECHA_NACIMIENTO DATE NOT NULL,
  SEXO CHAR(1) NOT NULL,
  CATEGORIA_FAVORITA INTEGER NOT NULL,
  TIPO_USUARIO INTEGER NOT NULL,
  CONSTRAINT SEXO_VALIDO CHECK (SEXO IN ('H','M')),
  PRIMARY KEY (ID_USUARIO));

CREATE TABLE ESTUDIO (
  ID_ESTUDIO INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY (START WITH 1, INCREMENT BY 1),
  ANALISTA INTEGER NOT NULL,
  VENDEDOR INTEGER NOT NULL,
  INGRESO DOUBLE NOT NULL,
  PRIMARY KEY (ID_ESTUDIO));

CREATE TABLE LISTA_PRODUCTO (
  PRODUCTO INTEGER NOT NULL,
  USUARIO INTEGER NOT NULL,
  PRIMARY KEY (PRODUCTO, USUARIO));

CREATE TABLE LISTA_USUARIO (
  ID_LISTA_USUARIO INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY (START WITH 1, INCREMENT BY 1),
  NOMBRE VARCHAR(45) NOT NULL,
  PRIMARY KEY (ID_LISTA_USUARIO));

CREATE TABLE NOTIFICACION (
  ID_NOTIFICACION INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY (START WITH 1, INCREMENT BY 1),
  NOTIFICANTE INTEGER NOT NULL,
  CONTENIDO VARCHAR(200) NOT NULL,
  FECHA_ENVIO DATE NOT NULL,
  LISTA_USUARIO INTEGER NOT NULL,
  PRIMARY KEY (ID_NOTIFICACION));

CREATE TABLE PUJA (
  ID_PUJA INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY (START WITH 1, INCREMENT BY 1),
  COMPRADOR INTEGER NOT NULL,
  PRODUCTO INTEGER NOT NULL,
  PRIMARY KEY (ID_PUJA));

CREATE TABLE  TIPO_USUARIO (
  ID_TIPO_USUARIO INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY (START WITH 1, INCREMENT BY 1),
  TIPO VARCHAR(45) NOT NULL,
  PRIMARY KEY (ID_TIPO_USUARIO),
  UNIQUE(TIPO));

CREATE TABLE USUARIO_LISTA_USUARIO (
  USUARIO INTEGER NOT NULL,
  LISTA INTEGER NOT NULL,
  NOMBRE VARCHAR(45) NOT NULL,
  PRIMARY KEY (USUARIO, LISTA));

ALTER TABLE USUARIO
  ADD FOREIGN KEY (CATEGORIA_FAVORITA) REFERENCES CATEGORIA (ID_CATEGORIA);
ALTER TABLE USUARIO
  ADD FOREIGN KEY (DIRECCION) REFERENCES DIRECCION (ID_DIRECCION);
ALTER TABLE USUARIO
  ADD FOREIGN KEY (TIPO_USUARIO) REFERENCES TIPO_USUARIO (ID_TIPO_USUARIO);


ALTER TABLE ESTUDIO
  ADD FOREIGN KEY (ANALISTA) REFERENCES USUARIO (ID_USUARIO);
ALTER TABLE ESTUDIO
  ADD FOREIGN KEY (VENDEDOR) REFERENCES USUARIO (ID_USUARIO);

ALTER TABLE LISTA_PRODUCTO
  ADD FOREIGN KEY (PRODUCTO) REFERENCES PRODUCTO (ID_PRODUCTO);
ALTER TABLE LISTA_PRODUCTO
  ADD FOREIGN KEY (USUARIO) REFERENCES USUARIO (ID_USUARIO);

ALTER TABLE NOTIFICACION
  ADD FOREIGN KEY (LISTA_USUARIO) REFERENCES LISTA_USUARIO (ID_LISTA_USUARIO);
ALTER TABLE NOTIFICACION
  ADD FOREIGN KEY (NOTIFICANTE) REFERENCES USUARIO (ID_USUARIO);

ALTER TABLE USUARIO_LISTA_USUARIO
  ADD FOREIGN KEY (LISTA) REFERENCES LISTA_USUARIO (ID_LISTA_USUARIO);
ALTER TABLE USUARIO_LISTA_USUARIO
  ADD FOREIGN KEY (USUARIO) REFERENCES USUARIO (ID_USUARIO);

ALTER TABLE CATEGORIA_PRODUCTO
  ADD FOREIGN KEY (CATEGORIA) REFERENCES CATEGORIA (ID_CATEGORIA);
ALTER TABLE CATEGORIA_PRODUCTO
  ADD FOREIGN KEY (PRODUCTO) REFERENCES PRODUCTO (ID_PRODUCTO);

ALTER TABLE PUJA 
  ADD FOREIGN KEY (PRODUCTO) REFERENCES PRODUCTO (ID_PRODUCTO);
ALTER TABLE PUJA 
  ADD FOREIGN KEY (COMPRADOR) REFERENCES USUARIO (ID_USUARIO);